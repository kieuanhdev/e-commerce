# ğŸ‘¤ GIáº¢I THÃCH CHI TIáº¾T FEATURES PROFILE & SETTINGS

## ğŸ—ï¸ KIáº¾N TRÃšC Tá»”NG QUAN

Profile vÃ  Settings Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ quáº£n lÃ½ thÃ´ng tin user vÃ  cÃ i Ä‘áº·t tÃ i khoáº£n. ChÃºng táº­n dá»¥ng Auth repository Ä‘á»ƒ thao tÃ¡c vá»›i user data:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     PRESENTATION LAYER (UI)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Profile  â”‚ Settings â”‚ BLoC         â”‚  â”‚
â”‚  â”‚ Screen   â”‚ Screen   â”‚ (State Mgmt) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     DOMAIN LAYER (Business Logic)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ UseCases â”‚ Repository Interface    â”‚  â”‚
â”‚  â”‚          â”‚ (IAuthRepository)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     DATA LAYER (External Data)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Models   â”‚ Data-    â”‚ Repository  â”‚  â”‚
â”‚  â”‚          â”‚ sources  â”‚ Impl        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**LÆ°u Ã½ quan trá»ng:**
- Profile chá»‰ cÃ³ Presentation layer (Ä‘á»c tá»« AuthBloc)
- Settings cÃ³ Domain layer vá»›i use cases riÃªng
- Cáº£ 2 Ä‘á»u dÃ¹ng chung `IAuthRepository` tá»« Auth feature

---

## ğŸ“ Cáº¤U TRÃšC THÆ¯ Má»¤C

```
lib/features/
â”œâ”€â”€ profile/                       # PROFILE FEATURE
â”‚   â””â”€â”€ presentation/
â”‚       â””â”€â”€ profile_screen.dart   # Display user profile, navigation
â”‚
â””â”€â”€ settings/                      # SETTINGS FEATURE
    â”œâ”€â”€ domain/
    â”‚   â””â”€â”€ usecase/              # Business logic operations
    â”‚       â”œâ”€â”€ get_current_user.dart
    â”‚       â”œâ”€â”€ update_user_settings.dart
    â”‚       â”œâ”€â”€ change_password.dart
    â”‚       â””â”€â”€ upload_avatar_image.dart
    â””â”€â”€ presentation/
        â”œâ”€â”€ bloc/                 # BLoC State Management
        â”‚   â”œâ”€â”€ settings_bloc.dart
        â”‚   â”œâ”€â”€ settings_event.dart
        â”‚   â””â”€â”€ settings_state.dart
        â”œâ”€â”€ settings_screen.dart
        â””â”€â”€ widgets/
            â””â”€â”€ settings_text_field.dart
```

---

## ğŸ”„ LUá»’NG HOáº T Äá»˜NG CHI TIáº¾T

### 1. ğŸ‘¤ PROFILE FEATURE - Hiá»ƒn thá»‹ thÃ´ng tin user

#### **ProfileScreen** (`presentation/profile_screen.dart`)

**Chá»©c nÄƒng:**
- âœ… Hiá»ƒn thá»‹ thÃ´ng tin user (avatar, tÃªn, email)
- âœ… Navigation Ä‘áº¿n Orders, Settings
- âœ… Logout functionality

**Äáº·c Ä‘iá»ƒm:**
- **Stateless**: KhÃ´ng quáº£n lÃ½ state riÃªng, Ä‘á»c tá»« AuthBloc
- **Reactive**: Tá»± Ä‘á»™ng update khi auth state thay Ä‘á»•i
- **Simple**: Chá»‰ Ä‘á»ƒ hiá»ƒn thá»‹, khÃ´ng cÃ³ logic phá»©c táº¡p

**Luá»“ng hoáº¡t Ä‘á»™ng:**
```
App start
  â†’ ProfileScreen build
    â†’ BlocBuilder<AuthBloc, AuthState>
      â†’ Check AuthState
        â†’ AuthAuthenticated: Hiá»ƒn thá»‹ user info
          â†’ Avatar (network/asset)
          â†’ Display name
          â†’ Email
          â†’ Navigation tiles (Orders, Settings, Logout)
        â†’ KhÃ¡c: Show loading/error
```

**Code structure:**
```dart
class ProfileScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: BlocBuilder<AuthBloc, AuthState>(
        builder: (context, authState) {
          if (authState is AuthAuthenticated) {
            final user = authState.user;
            // Hiá»ƒn thá»‹ thÃ´ng tin user
            return ListView(
              children: [
                // Avatar + Name + Email
                // Navigation tiles
              ],
            );
          }
          return CircularProgressIndicator();
        },
      ),
    );
  }
}
```

**Navigation tiles:**
1. **"ÄÆ¡n hÃ ng cá»§a tÃ´i"** â†’ Navigate to Orders screen
2. **"CÃ i Ä‘áº·t"** â†’ Navigate to Settings screen
3. **"ÄÄƒng xuáº¥t"** â†’ Trigger logout:
   ```dart
   context.read<AuthBloc>().add(AuthLogoutRequested());
   ```

**Avatar display:**
```dart
final avatar = (user.avatarUrl != null && user.avatarUrl!.isNotEmpty)
    ? NetworkImage(user.avatarUrl!)  // Cloudinary URL
    : const AssetImage('images/avatar.png')  // Default avatar
```

**Äáº·c biá»‡t:**
- âœ… Fallback vá» default avatar náº¿u chÆ°a cÃ³ avatarUrl
- âœ… Real-time update khi user thay Ä‘á»•i profile (qua AuthBloc stream)

---

### 2. âš™ï¸ SETTINGS FEATURE - Quáº£n lÃ½ cÃ i Ä‘áº·t tÃ i khoáº£n

#### **A. Domain Layer - Use Cases**

##### **1. GetCurrentUserUseCase** (`domain/usecase/get_current_user.dart`)

```dart
class GetCurrentUserUseCase {
  final IAuthRepository repo;
  GetCurrentUserUseCase(this.repo);
  
  Future<AppUser?> call() => repo.getCurrentUser();
}
```

**Nhiá»‡m vá»¥:**
- Láº¥y user hiá»‡n táº¡i tá»« Auth repository
- DÃ¹ng cho Settings screen Ä‘á»ƒ load profile data

**Luá»“ng:**
```
GetCurrentUserUseCase()
  â†’ IAuthRepository.getCurrentUser()
    â†’ FirebaseAuthDatasource.getCurrentUser()
      â†’ FirebaseAuth.currentUser
        â†’ Firestore: get user profile
          â†’ Return AppUser
```

##### **2. UpdateUserSettingsUseCase** (`domain/usecase/update_user_settings.dart`)

```dart
class UpdateUserSettingsUseCase {
  final IAuthRepository repo;
  UpdateUserSettingsUseCase(this.repo);
  
  Future<AppUser?> call({
    String? displayName,
    String? avatarUrl,
    String? phoneNumber,
    String? defaultAddressId,
  }) {
    return repo.updateUser(
      displayName: displayName,
      avatarUrl: avatarUrl,
      phoneNumber: phoneNumber,
      defaultAddressId: defaultAddressId,
    );
  }
}
```

**Nhiá»‡m vá»¥:**
- Cáº­p nháº­t thÃ´ng tin user profile
- Tráº£ vá» AppUser Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t

**LÆ°u Ã½:**
- Chá»‰ update cÃ¡c fields Ä‘Æ°á»£c truyá»n vÃ o (null = khÃ´ng update)
- Sync displayName lÃªn Firebase Auth profile

##### **3. ChangePasswordUseCase** (`domain/usecase/change_password.dart`)

```dart
class ChangePasswordUseCase {
  final IAuthRepository repo;
  ChangePasswordUseCase(this.repo);
  
  Future<Either<Failure, void>> call({
    required String currentPassword,
    required String newPassword,
  }) {
    return repo.changePassword(
      currentPassword: currentPassword,
      newPassword: newPassword,
    );
  }
}
```

**Nhiá»‡m vá»¥:**
- Äá»•i máº­t kháº©u user
- YÃªu cáº§u re-authentication vá»›i password cÅ©
- Return Either Ä‘á»ƒ handle errors

**Security:**
- âœ… Re-authentication báº¯t buá»™c
- âœ… Either pattern Ä‘á»ƒ handle errors type-safely

##### **4. UploadAvatarImageUseCase** (`domain/usecase/upload_avatar_image.dart`)

```dart
class UploadAvatarImageUseCase {
  final IAuthRepository repo;
  UploadAvatarImageUseCase(this.repo);
  
  Future<AppUser?> call(XFile imageFile) {
    return repo.uploadAvatarImage(imageFile);
  }
}
```

**Nhiá»‡m vá»¥:**
- Upload áº£nh avatar lÃªn Cloudinary
- Update avatarUrl trong Firestore
- Tráº£ vá» AppUser Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t

**Luá»“ng:**
```
UploadAvatarImageUseCase(imageFile)
  â†’ IAuthRepository.uploadAvatarImage()
    â†’ CloudinaryService.uploadAvatarImage()
      â†’ Upload lÃªn Cloudinary (folder: 'avatars')
        â†’ Nháº­n secure URL
          â†’ AuthRepository.updateUser(avatarUrl: url)
            â†’ Firestore: update avatarUrl
              â†’ Sync displayName (náº¿u cáº§n)
                â†’ Return updated AppUser
```

---

#### **B. Presentation Layer - BLoC Pattern**

##### **SettingsEvent** (`presentation/bloc/settings_event.dart`)

```dart
abstract class SettingsEvent extends Equatable {}

class LoadSettings extends SettingsEvent {}
// Load user data khi má»Ÿ Settings screen

class UpdateUserSettings extends SettingsEvent {
  final String? displayName;
  final XFile? avatarImageFile;  // áº¢nh má»›i Ä‘Ã£ chá»n
  final String? phoneNumber;
  final String? defaultAddressId;
}
// Cáº­p nháº­t thÃ´ng tin user

class ChangePasswordRequested extends SettingsEvent {
  final String currentPassword;
  final String newPassword;
}
// Äá»•i máº­t kháº©u

class ImageSelected extends SettingsEvent {
  final XFile imageFile;
}
// Chá»n áº£nh Ä‘á»ƒ preview (chÆ°a upload)
```

**Äáº·c Ä‘iá»ƒm:**
- `ImageSelected`: Chá»‰ Ä‘á»ƒ preview, chÆ°a upload
- `UpdateUserSettings`: Xá»­ lÃ½ upload vÃ  update cÃ¹ng lÃºc

##### **SettingsState** (`presentation/bloc/settings_state.dart`)

```dart
abstract class SettingsState extends Equatable {}

class SettingsInitial extends SettingsState {}
// Initial state

class SettingsLoading extends SettingsState {}
// Äang load/process

class SettingsLoaded extends SettingsState {
  final AppUser user;
  final String? selectedImagePath;  // Path cá»§a áº£nh Ä‘Ã£ chá»n (preview)
}
// ÄÃ£ load thÃ nh cÃ´ng

class SettingsError extends SettingsState {
  final String message;
}
// CÃ³ lá»—i xáº£y ra

class SettingsUpdated extends SettingsState {
  final String message;
}
// Update thÃ nh cÃ´ng

class UploadingAvatar extends SettingsState {
  final AppUser user;
}
// Äang upload avatar (optional, cÃ³ thá»ƒ khÃ´ng dÃ¹ng)
```

**State machine:**
```
SettingsInitial
  â†“
SettingsLoading â†’ SettingsLoaded
  â†“                â†“
SettingsError    (user cÃ³ thá»ƒ edit)
                  â†“
              UpdateUserSettings event
                  â†“
              SettingsLoading
                  â†“
              SettingsUpdated â†’ SettingsLoaded (updated user)
                  â†“
              SettingsError (náº¿u fail)
```

**Äáº·c biá»‡t:**
- `selectedImagePath`: LÆ°u path cá»§a áº£nh Ä‘Ã£ chá»n Ä‘á»ƒ preview, nhÆ°ng chÆ°a upload
- Sau khi upload thÃ nh cÃ´ng â†’ `selectedImagePath = null`

##### **SettingsBloc** (`presentation/bloc/settings_bloc.dart`)

**Constructor - Auto load:**
```dart
SettingsBloc({...}) : super(SettingsInitial()) {
  // Register event handlers
  on<LoadSettings>(_onLoadSettings);
  on<ImageSelected>(_onImageSelected);
  on<UpdateUserSettings>(_onUpdateUserSettings);
  on<ChangePasswordRequested>(_onChangePasswordRequested);
  
  // Auto load khi khá»Ÿi táº¡o
  add(LoadSettings());
}
```

**Äáº·c biá»‡t:**
- âœ… Tá»± Ä‘á»™ng load user data khi khá»Ÿi táº¡o bloc
- âœ… KhÃ´ng cáº§n gá»i LoadSettings manually tá»« UI

**1. LoadSettings Handler:**
```dart
on<LoadSettings>((event, emit) async {
  emit(SettingsLoading());
  try {
    final user = await getCurrentUser();
    if (user == null) {
      emit(const SettingsError('KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n!'));
    } else {
      emit(SettingsLoaded(user));
    }
  } catch (e) {
    emit(SettingsError(e.toString()));
  }
});
```

**2. ImageSelected Handler:**
```dart
on<ImageSelected>((event, emit) async {
  final currentState = state;
  if (currentState is SettingsLoaded) {
    // Chá»‰ cáº­p nháº­t selectedImagePath Ä‘á»ƒ preview
    // ChÆ°a upload lÃªn Cloudinary
    emit(SettingsLoaded(
      currentState.user,
      selectedImagePath: event.imageFile.path,
    ));
  }
});
```

**Äáº·c biá»‡t:**
- âœ… Preview pattern: Chá»n áº£nh â†’ Preview ngay â†’ Upload khi user click "LÆ°u"
- âœ… Better UX: User tháº¥y preview trÆ°á»›c khi commit

**3. UpdateUserSettings Handler:**
```dart
on<UpdateUserSettings>((event, emit) async {
  emit(SettingsLoading());
  try {
    String? avatarUrl;
    
    // BÆ°á»›c 1: Upload áº£nh náº¿u cÃ³
    if (event.avatarImageFile != null) {
      try {
        final updated = await uploadAvatarImageUseCase(event.avatarImageFile!);
        if (updated != null) {
          avatarUrl = updated.avatarUrl;  // Láº¥y URL tá»« Cloudinary
        } else {
          emit(const SettingsError('Upload avatar tháº¥t báº¡i!'));
          // Rollback: Load láº¡i user data
          final user = await getCurrentUser();
          if (user != null) {
            emit(SettingsLoaded(user));
          }
          return;
        }
      } catch (e) {
        emit(SettingsError('Lá»—i khi upload avatar: $e'));
        // Rollback
        final user = await getCurrentUser();
        if (user != null) {
          emit(SettingsLoaded(user));
        }
        return;
      }
    }
    
    // BÆ°á»›c 2: Update user settings (bao gá»“m avatarUrl náº¿u cÃ³)
    final updated = await updateUserSettings(
      displayName: event.displayName,
      avatarUrl: avatarUrl,
      phoneNumber: event.phoneNumber,
      defaultAddressId: event.defaultAddressId,
    );
    
    if (updated == null) {
      emit(const SettingsError('Cáº­p nháº­t tháº¥t báº¡i!'));
    } else {
      emit(SettingsUpdated('Cáº­p nháº­t thÃ nh cÃ´ng!'));
      emit(SettingsLoaded(updated));  // Reset selectedImagePath = null
    }
  } catch (e) {
    emit(SettingsError(e.toString()));
  }
});
```

**Luá»“ng upload avatar:**
```
UpdateUserSettings event (cÃ³ avatarImageFile)
  â†“
1. UploadAvatarImageUseCase
   â†’ Upload lÃªn Cloudinary
     â†’ Success: Láº¥y avatarUrl
     â†’ Error: Rollback, emit error
  â†“
2. UpdateUserSettingsUseCase
   â†’ Update Firestore vá»›i avatarUrl + displayName + ...
     â†’ Success: SettingsUpdated â†’ SettingsLoaded
     â†’ Error: SettingsError
```

**Äáº·c biá»‡t:**
- âœ… 2-step process: Upload image â†’ Update profile
- âœ… Error handling: Rollback vá» user data cÅ© náº¿u upload fail
- âœ… Atomic operation: Náº¿u upload fail â†’ khÃ´ng update profile

**4. ChangePasswordRequested Handler:**
```dart
on<ChangePasswordRequested>((event, emit) async {
  try {
    final result = await changePasswordUseCase(
      currentPassword: event.currentPassword,
      newPassword: event.newPassword,
    );
    
    result.fold(
      (failure) => emit(SettingsError(failure.message)),
      (_) => emit(const SettingsUpdated('Äá»•i máº­t kháº©u thÃ nh cÃ´ng!')),
    );
  } catch (e) {
    emit(SettingsError(e.toString()));
  }
});
```

**Äáº·c biá»‡t:**
- âœ… Either pattern Ä‘á»ƒ handle errors
- âœ… Success message Ä‘á»ƒ notify user

---

#### **C. UI Screen**

##### **SettingsScreen** (`presentation/settings_screen.dart`)

**State Management:**
```dart
class _SettingsScreenState extends State<SettingsScreen> {
  final TextEditingController _displayNameController = TextEditingController();
  final TextEditingController _currentPasswordController = TextEditingController();
  final TextEditingController _newPasswordController = TextEditingController();
  final TextEditingController _confirmPasswordController = TextEditingController();
  final ImagePicker _imagePicker = ImagePicker();
  bool _initialized = false;
  Uint8List? _previewImageBytes;  // Bytes cá»§a áº£nh Ä‘á»ƒ preview
}
```

**Äáº·c Ä‘iá»ƒm:**
- âœ… Local controllers Ä‘á»ƒ quáº£n lÃ½ form inputs
- âœ… `_previewImageBytes`: LÆ°u bytes Ä‘á»ƒ preview áº£nh (chÆ°a upload)

**Avatar Selection Flow:**
```dart
Future<void> _pickImage(BuildContext blocContext) async {
  // 1. Show dialog chá»n nguá»“n (Camera/Gallery)
  final ImageSource? source = await showDialog<ImageSource>(...);
  
  if (source == null) return;
  
  // 2. Pick image
  final XFile? image = await _imagePicker.pickImage(
    source: source,
    imageQuality: 85,
    maxWidth: 800,
    maxHeight: 800,
  );
  
  if (image != null) {
    // 3. Read bytes Ä‘á»ƒ preview
    final imageBytes = await image.readAsBytes();
    setState(() {
      _previewImageBytes = imageBytes;
    });
    
    // 4. Emit ImageSelected event (chá»‰ Ä‘á»ƒ preview, chÆ°a upload)
    blocContext.read<SettingsBloc>().add(ImageSelected(imageFile: image));
  }
}
```

**Luá»“ng preview:**
```
User tap avatar
  â†’ _pickImage()
    â†’ Dialog: Camera/Gallery
      â†’ ImagePicker.pickImage()
        â†’ Read bytes â†’ _previewImageBytes
          â†’ setState() â†’ UI update vá»›i preview
            â†’ SettingsBloc.add(ImageSelected())
              â†’ SettingsLoaded vá»›i selectedImagePath
```

**Avatar Display Logic:**
```dart
CircleAvatar(
  backgroundImage: _previewImageBytes != null
      ? MemoryImage(_previewImageBytes!)  // Preview áº£nh má»›i
      : (user.avatarUrl != null && user.avatarUrl!.isNotEmpty)
          ? NetworkImage(user.avatarUrl!)  // Avatar hiá»‡n táº¡i
          : const AssetImage('images/avatar.png')  // Default
)
```

**Priority order:**
1. Preview image (náº¿u cÃ³) - Æ°u tiÃªn cao nháº¥t
2. Network image (avatarUrl tá»« server)
3. Default asset image

**Save Settings Flow:**
```dart
onPressed: () {
  final currentState = context.read<SettingsBloc>().state;
  XFile? selectedImage;
  
  // Láº¥y XFile tá»« selectedImagePath náº¿u cÃ³
  if (currentState is SettingsLoaded && currentState.selectedImagePath != null) {
    selectedImage = XFile(currentState.selectedImagePath!);
  }
  
  // Emit UpdateUserSettings event
  context.read<SettingsBloc>().add(
    UpdateUserSettings(
      displayName: _displayNameController.text.trim(),
      avatarImageFile: selectedImage,  // Chá»‰ cÃ³ náº¿u user Ä‘Ã£ chá»n áº£nh má»›i
    ),
  );
}
```

**Change Password Flow:**
```dart
onPressed: () {
  final current = _currentPasswordController.text.trim();
  final next = _newPasswordController.text.trim();
  final confirm = _confirmPasswordController.text.trim();
  
  // Validation
  if (next.isEmpty || current.isEmpty) {
    // Show error
    return;
  }
  
  if (next != confirm) {
    // Show error: passwords don't match
    return;
  }
  
  // Emit ChangePasswordRequested event
  context.read<SettingsBloc>().add(
    ChangePasswordRequested(
      currentPassword: current,
      newPassword: next,
    ),
  );
}
```

**BLoC Listener:**
```dart
BlocConsumer<SettingsBloc, SettingsState>(
  listener: (context, state) {
    if (state is SettingsUpdated) {
      // Show success snackbar
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(state.message),
          backgroundColor: Colors.green,
        ),
      );
    }
    if (state is SettingsError) {
      // Show error snackbar
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(state.message),
          backgroundColor: Colors.red,
        ),
      );
    }
  },
  builder: (context, state) {
    // Build UI based on state
  },
)
```

**Reset Preview sau khi save:**
```dart
if (state is SettingsLoaded) {
  // Náº¿u Ä‘Ã£ save thÃ nh cÃ´ng (selectedImagePath = null)
  // Reset preview bytes
  if (state.selectedImagePath == null && _previewImageBytes != null) {
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (mounted) {
        setState(() {
          _previewImageBytes = null;
        });
      }
    });
  }
}
```

---

## ğŸ”‘ ÄIá»‚M Cáº¦N LÆ¯U Ã QUAN TRá»ŒNG

### 1. âš ï¸ Shared Repository Pattern

**Váº¥n Ä‘á»:**
- Settings use cases dÃ¹ng chung `IAuthRepository` vá»›i Auth feature
- Profile Ä‘á»c tá»« `AuthBloc` (khÃ´ng cÃ³ repository riÃªng)

**Lá»£i Ã­ch:**
- âœ… DRY (Don't Repeat Yourself): KhÃ´ng duplicate code
- âœ… Single source of truth: User data chá»‰ á»Ÿ má»™t nÆ¡i
- âœ… Consistency: CÃ¹ng má»™t cÃ¡ch update user data

**LÆ°u Ã½:**
- Settings updates sáº½ trigger AuthBloc stream (vÃ¬ dÃ¹ng chung repository)
- Profile screen sáº½ tá»± Ä‘á»™ng update khi Settings thay Ä‘á»•i

### 2. ğŸ“¸ Avatar Upload Strategy

**2-step process:**
1. **Preview**: User chá»n áº£nh â†’ Preview ngay (local)
2. **Upload**: User click "LÆ°u" â†’ Upload lÃªn Cloudinary â†’ Update Firestore

**Lá»£i Ã­ch:**
- âœ… Better UX: User tháº¥y preview trÆ°á»›c khi commit
- âœ… Save bandwidth: Chá»‰ upload khi user confirm
- âœ… Cancel option: User cÃ³ thá»ƒ cancel trÆ°á»›c khi upload

**Implementation:**
- `selectedImagePath`: LÆ°u path Ä‘á»ƒ reference
- `_previewImageBytes`: LÆ°u bytes Ä‘á»ƒ hiá»ƒn thá»‹ preview
- Upload chá»‰ xáº£y ra khi `UpdateUserSettings` event cÃ³ `avatarImageFile`

### 3. ğŸ”„ State Synchronization

**Profile â†” Settings sync:**
```
Settings screen: Update profile
  â†’ UpdateUserSettingsUseCase
    â†’ AuthRepository.updateUser()
      â†’ Firestore: update user profile
        â†’ AuthBloc.authStateChanges stream
          â†’ Auto emit AuthStateChanged
            â†’ Profile screen auto update (BlocBuilder)
```

**Äáº·c biá»‡t:**
- âœ… Real-time sync giá»¯a Profile vÃ  Settings
- âœ… No manual refresh needed
- âœ… Consistent data across screens

### 4. ğŸ”’ Password Change Security

**Requirements:**
- âœ… Re-authentication vá»›i password cÅ© (báº¯t buá»™c)
- âœ… Validation: New password â‰  current password
- âœ… Confirm password match
- âœ… Either pattern Ä‘á»ƒ handle errors type-safely

**Flow:**
```
User nháº­p passwords
  â†’ Validation (khÃ´ng rá»—ng, khá»›p)
    â†’ ChangePasswordUseCase
      â†’ AuthRepository.changePassword()
        â†’ FirebaseAuthDatasource.changePassword()
          â†’ Re-authenticate vá»›i currentPassword
            â†’ Update password
              â†’ Success/Error
```

### 5. ğŸ¨ Image Preview Pattern

**Implementation:**
```dart
// 1. Chá»n áº£nh
final imageBytes = await image.readAsBytes();
setState(() => _previewImageBytes = imageBytes);

// 2. Preview trong UI
Image.memory(_previewImageBytes!)

// 3. Upload khi save
if (selectedImage != null) {
  uploadAvatarImageUseCase(selectedImage);
}
```

**Lá»£i Ã­ch:**
- âœ… Instant feedback
- âœ… No network request until save
- âœ… Better UX

### 6. ğŸ”„ Auto Load on Init

**SettingsBloc constructor:**
```dart
SettingsBloc({...}) : super(SettingsInitial()) {
  // Register handlers
  // ...
  
  // Auto load
  add(LoadSettings());
}
```

**Lá»£i Ã­ch:**
- âœ… No manual load needed tá»« UI
- âœ… Always fresh data when screen opens

**LÆ°u Ã½:**
- âš ï¸ CÃ³ thá»ƒ trigger multiple loads náº¿u bloc Ä‘Æ°á»£c recreate nhiá»u láº§n
- âš ï¸ Cáº§n Ä‘áº£m báº£o bloc lifecycle Ä‘Æ°á»£c quáº£n lÃ½ Ä‘Ãºng

### 7. ğŸ“ Form Validation

**Display Name:**
- âœ… Optional (cÃ³ thá»ƒ Ä‘á»ƒ trá»‘ng)
- âœ… Trim whitespace

**Password:**
- âœ… Required fields
- âœ… New password â‰  current password (cÃ³ thá»ƒ check)
- âœ… Confirm password match
- âœ… Minimum length (Firebase: â‰¥ 6 chars)

### 8. ğŸ¯ Error Handling

**Strategy:**
- âœ… Try-catch trong bloc handlers
- âœ… Either pattern cho password change
- âœ… Rollback state náº¿u upload fail
- âœ… User-friendly error messages (tiáº¿ng Viá»‡t)

**Error recovery:**
```dart
// Náº¿u upload fail, rollback vá» user data cÅ©
catch (e) {
  emit(SettingsError('Lá»—i khi upload avatar: $e'));
  final user = await getCurrentUser();
  if (user != null) {
    emit(SettingsLoaded(user));  // Restore previous state
  }
  return;
}
```

---

## ğŸ’¡ ÄIá»‚M HAY Cá»¦A KIáº¾N TRÃšC

### 1. ğŸ—ï¸ Separation of Concerns

**Profile:**
- âœ… Chá»‰ Ä‘á»ƒ display, khÃ´ng cÃ³ business logic
- âœ… Äá»c tá»« AuthBloc (shared state)

**Settings:**
- âœ… Domain layer riÃªng (use cases)
- âœ… Business logic tÃ¡ch biá»‡t khá»i UI
- âœ… Testable

### 2. ğŸ”„ Reactive Updates

**Real-time sync:**
- âœ… Settings update â†’ AuthBloc stream â†’ Profile auto update
- âœ… No manual refresh needed
- âœ… Consistent data

### 3. ğŸ“¸ Smart Image Handling

**Preview pattern:**
- âœ… Local preview trÆ°á»›c khi upload
- âœ… Better UX
- âœ… Save bandwidth

### 4. ğŸ¯ BLoC Pattern

**State management:**
- âœ… Predictable state transitions
- âœ… Easy to test
- âœ… Clear separation

### 5. â™»ï¸ Reuse Auth Repository

**DRY principle:**
- âœ… KhÃ´ng duplicate code
- âœ… Single source of truth
- âœ… Consistent updates

---

## ğŸš€ CÃC ÄIá»‚M CÃ“ THá»‚ Cáº¢I THIá»†N

### 1. ğŸ“± Profile Feature Enhancement

**Hiá»‡n táº¡i:**
- Chá»‰ hiá»ƒn thá»‹ basic info

**CÃ³ thá»ƒ thÃªm:**
- Edit profile tá»« Profile screen
- Orders count
- Total spent
- Join date display
- Address management

### 2. âš™ï¸ Settings Feature Enhancement

**Hiá»‡n táº¡i:**
- Basic profile update
- Password change

**CÃ³ thá»ƒ thÃªm:**
- Email verification
- Phone number verification
- Notification settings
- Privacy settings
- Language selection
- Theme settings (dark mode)

### 3. ğŸ”„ State Management

**Hiá»‡n táº¡i:**
- SettingsBloc auto-load trong constructor

**CÃ³ thá»ƒ cáº£i thiá»‡n:**
- Loading state riÃªng cho tá»«ng operation
- Optimistic updates
- Retry mechanism

### 4. ğŸ“¸ Image Handling

**Hiá»‡n táº¡i:**
- Basic preview vÃ  upload

**CÃ³ thá»ƒ cáº£i thiá»‡n:**
- Image cropping
- Image compression before upload
- Multiple image sizes (thumbnail, full)
- Image caching

### 5. ğŸ”’ Security

**CÃ³ thá»ƒ thÃªm:**
- Password strength indicator
- 2FA setup
- Active sessions management
- Login history

### 6. ğŸ“Š Analytics

**CÃ³ thá»ƒ thÃªm:**
- Track profile updates
- Track password changes
- User engagement metrics

---

## ğŸ“Š TÃ“M Táº®T LUá»’NG HOáº T Äá»˜NG

### **Profile Screen:**
```
1. App navigate to ProfileScreen
2. BlocBuilder<AuthBloc, AuthState>
3. Check AuthState:
   â†’ AuthAuthenticated: 
     â†’ Display user info (avatar, name, email)
     â†’ Navigation tiles
   â†’ KhÃ¡c: Show loading
4. User tap navigation:
   â†’ Orders: Navigate to orders
   â†’ Settings: Navigate to settings
   â†’ Logout: AuthBloc.add(AuthLogoutRequested())
```

### **Settings Screen - Load:**
```
1. App navigate to SettingsScreen
2. BlocProvider create SettingsBloc
3. SettingsBloc constructor:
   â†’ add(LoadSettings())
4. LoadSettings handler:
   â†’ GetCurrentUserUseCase()
     â†’ IAuthRepository.getCurrentUser()
       â†’ Return AppUser
5. emit(SettingsLoaded(user))
6. UI populate form fields
```

### **Settings Screen - Update Profile:**
```
1. User edit display name
2. User select new avatar
   â†’ _pickImage()
     â†’ ImagePicker
       â†’ Read bytes â†’ _previewImageBytes
         â†’ setState() â†’ Preview in UI
           â†’ SettingsBloc.add(ImageSelected())
3. User click "LÆ°u thay Ä‘á»•i"
   â†’ SettingsBloc.add(UpdateUserSettings(...))
4. UpdateUserSettings handler:
   â†’ If avatarImageFile != null:
     â†’ UploadAvatarImageUseCase()
       â†’ Upload to Cloudinary
         â†’ Get avatarUrl
   â†’ UpdateUserSettingsUseCase()
     â†’ Update Firestore
       â†’ Return updated AppUser
5. emit(SettingsUpdated()) â†’ emit(SettingsLoaded(updated))
6. AuthBloc stream auto-update
7. Profile screen auto-update
```

### **Settings Screen - Change Password:**
```
1. User enter passwords
2. Validation (not empty, match)
3. User click "Äá»•i máº­t kháº©u"
   â†’ SettingsBloc.add(ChangePasswordRequested(...))
4. ChangePasswordRequested handler:
   â†’ ChangePasswordUseCase()
     â†’ IAuthRepository.changePassword()
       â†’ FirebaseAuthDatasource.changePassword()
         â†’ Re-authenticate
           â†’ Update password
5. Either<Failure, void>:
   â†’ Left: emit(SettingsError)
   â†’ Right: emit(SettingsUpdated)
```

---

## âœ… CHECKLIST Äá»‚ Váº¬N HÃ€NH Tá»T

- [ ] AuthBloc Ä‘Æ°á»£c provide á»Ÿ root level
- [ ] SettingsBloc Ä‘Æ°á»£c create má»›i má»—i láº§n má»Ÿ screen (factory)
- [ ] Avatar upload path Ä‘Ãºng (Cloudinary config)
- [ ] Form validation hoáº¡t Ä‘á»™ng Ä‘Ãºng
- [ ] Password change validation Ä‘Ãºng
- [ ] Error messages user-friendly
- [ ] Preview image hoáº¡t Ä‘á»™ng Ä‘Ãºng
- [ ] State sync giá»¯a Profile vÃ  Settings
- [ ] Default avatar fallback hoáº¡t Ä‘á»™ng
- [ ] Loading states hiá»ƒn thá»‹ Ä‘Ãºng

---

## ğŸ“ Káº¾T LUáº¬N

Profile vÃ  Settings features Ä‘Æ°á»£c thiáº¿t káº¿ tá»‘t vá»›i:
- âœ… Clear separation: Profile chá»‰ display, Settings cÃ³ logic riÃªng
- âœ… Reuse Auth repository: DRY principle
- âœ… Real-time sync: Auto-update giá»¯a screens
- âœ… BLoC pattern: Predictable state management
- âœ… Smart image handling: Preview pattern

**Äiá»ƒm máº¡nh:**
- Kiáº¿n trÃºc sáº¡ch, dá»… maintain
- Reuse code hiá»‡u quáº£
- Real-time synchronization
- Good UX vá»›i preview pattern

**CÃ³ thá»ƒ cáº£i thiá»‡n:**
- More settings options
- Better image handling (cropping, compression)
- Enhanced validation
- Analytics tracking

---

**TÃ¡c giáº£:** AI Assistant  
**NgÃ y:** 2024

